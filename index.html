<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Geeta Tech Hub — News Widget</title>
<style>
  :root{--gth-accent:#ff5b60;--gth-bg:#fff;--gth-muted:#777;--gth-radius:12px}
  html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  .gth-wrap{max-width:980px;margin:12px auto;padding:12px}
  .gth-card{background:var(--gth-bg);border-radius:var(--gth-radius);box-shadow:0 8px 24px rgba(12,14,20,.06);overflow:hidden}
  .gth-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px}
  .gth-title{font-weight:700;font-size:18px;color:#111}
  .gth-sub{font-size:12px;color:var(--gth-muted)}
  .gth-layout{display:grid;gap:12px;padding:12px}
  .gth-featured{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;background:#fff}
  .gth-featured .img{flex:0 0 48%;max-height:260px;overflow:hidden;border-radius:10px}
  .gth-featured img{width:100%;height:100%;object-fit:cover;display:block}
  .gth-featured .meta{flex:1;display:flex;flex-direction:column;gap:8px}
  .gth-featured .headline{font-size:18px;font-weight:700;color:#111;line-height:1.15}
  .gth-featured .syn{font-size:14px;color:#222;line-height:1.4}
  .gth-featured .meta-row{display:flex;justify-content:space-between;align-items:center;color:var(--gth-muted);font-size:12px;margin-top:auto}
  .gth-featured a.read{border:1px solid var(--gth-accent);color:var(--gth-accent);padding:6px 10px;border-radius:8px;text-decoration:none;font-size:13px}
  .gth-sm-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
  .gth-sm{display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:#fff}
  .gth-sm .thumb{flex:0 0 86px;height:60px;border-radius:8px;overflow:hidden;background:#f2f2f2}
  .gth-sm img{width:100%;height:100%;object-fit:cover}
  .gth-sm .info{flex:1}
  .gth-sm .h{font-size:13px;font-weight:600;color:#111;margin-bottom:6px}
  .gth-sm .s{font-size:12px;color:var(--gth-muted)}
  .gth-footer{padding:10px 14px;font-size:12px;color:var(--gth-muted);text-align:right}
  .gth-loading{padding:24px;text-align:center;color:var(--gth-muted)}
  .gth-error{padding:20px;text-align:center;color:#b00020}
  @media(max-width:720px){.gth-featured{flex-direction:column}.gth-featured .img{width:100%;height:180px}}
</style>
</head>
<body>
<div class="gth-wrap">
  <div id="gth-root" class="gth-card" aria-label="Geeta Tech Hub News Widget">
    <div class="gth-header">
      <div><div class="gth-title">Geeta Tech Hub News</div><div class="gth-sub">Google News + Trending searches • quick synopses</div></div>
      <div class="gth-sub">Auto • Local</div>
    </div>
    <div id="gth-content" class="gth-layout">
      <div id="gth-loading" class="gth-loading">Loading headlines…</div>
    </div>
  </div>
</div>

<script>
(async function(){
  const country = 'IN';
  const smallCount = 4;
  const newsRSS = `https://news.google.com/rss?hl=en-${country}&gl=${country}&ceid=${country}:en`;
  const trendsRSS = `https://trends.google.com/trends/trendingsearches/daily/rss?geo=${country}`;

  // PROXY LIST - order matters; some return raw XML, rss2json returns JSON
  const proxies = [
    {name:'allorigins', url: u => 'https://api.allorigins.cf/raw?url=' + encodeURIComponent(u), type:'raw'},
    {name:'allorigins.win', url: u => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(u), type:'raw'},
    {name:'thingproxy', url: u => 'https://thingproxy.freeboard.io/fetch/' + u, type:'raw'},
    {name:'rss2json', url: u => 'https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(u), type:'rss2json'}
  ];

  const contentEl = document.getElementById('gth-content');
  const loadingEl = document.getElementById('gth-loading');

  function stripHtml(h){ if(!h) return ''; const d=document.createElement('div'); d.innerHTML=h; return d.textContent||d.innerText||''; }
  function shortify(t,l=140){ if(!t) return ''; t=stripHtml(t).replace(/\s+/g,' ').trim(); if(t.length<=l) return t; const s=t.slice(0,l); const last=Math.max(s.lastIndexOf('.'),s.lastIndexOf('!'),s.lastIndexOf('?')); return last>30? s.slice(0,last+1) : s+'…'; }
  function catchy(title,desc){ const d=shortify(desc,160); const templates=[title+' — quick take: '+d,'Why it matters: '+d,title+' — in brief: '+d,'Snapshot: '+d]; return templates[Math.floor(Math.random()*templates.length)]; }
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function fallbackSvgUrl(){ const svg="<svg xmlns='http://www.w3.org/2000/svg' width='200' height='120'><rect width='100%' height='100%' fill='%23f2f2f2'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23999' font-size='12'>No image</text></svg>"; return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); }

  // parse raw RSS XML items
  function parseRawRSS(xmlStr){
    try{
      const doc = new DOMParser().parseFromString(xmlStr, 'application/xml');
      if(doc.querySelector('parsererror')) { console.warn('parsererror', doc.querySelector('parsererror').textContent); return []; }
      return Array.from(doc.querySelectorAll('item')).map(it=>{
        const get = q => it.querySelector(q) ? it.querySelector(q).textContent : '';
        let image='';
        const m = it.querySelector('media\\:content, media\\:thumbnail');
        if(m && m.getAttribute && m.getAttribute('url')) image = m.getAttribute('url');
        if(!image){ const enc = it.querySelector('enclosure'); if(enc && enc.getAttribute) image = enc.getAttribute('url') || ''; }
        if(!image){ const r = /<img[^>]+src=["']?([^"'>\s]+)["']?/i.exec(get('content\\:encoded')||get('description')||''); if(r) image = r[1]; }
        return { title: get('title'), link: get('link')||get('guid'), content: get('content\\:encoded')||get('description'), pubDate: get('pubDate'), image };
      });
    }catch(e){ console.warn('parseRawRSS error', e); return []; }
  }

  // try proxies in sequence for one feed
  async function tryFetchFeed(url){
    for(const p of proxies){
      try{
        const fetchUrl = p.url(url);
        const res = await fetch(fetchUrl, {cache:'no-cache'});
        if(!res.ok){ console.warn('proxy',p.name,'status',res.status); continue; }
        if(p.type === 'raw'){
          const txt = await res.text();
          // if returned content is JSON with error, skip
          if(txt && (txt.trim().startsWith('{') || txt.trim().startsWith('['))){
            // some proxies may return JSON error; continue
            try{ JSON.parse(txt); console.warn('raw proxy returned JSON - skipping', p.name); continue; }catch(e){}
          }
          const items = parseRawRSS(txt);
          if(items.length) return items;
        } else if(p.type === 'rss2json'){
          const j = await res.json();
          if(j && j.items && j.items.length){
            // convert rss2json items to our shape
            return j.items.map(it=>({
              title: it.title,
              link: it.link,
              content: it.content || it.description || '',
              pubDate: it.pubDate,
              image: it.thumbnail || (it.enclosure && it.enclosure.link) || ''
            }));
          }
        }
      }catch(e){
        console.warn('proxy',p.name,'failed',e);
        continue;
      }
    }
    throw new Error('All proxies failed');
  }

  async function loadAll(){
    loadingEl.textContent = 'Loading headlines…';
    try{
      // fetch both feeds (news + trends) via same proxy attempts
      const [newsItems, trendsItems] = await Promise.all([ tryFetchFeed(newsRSS), tryFetchFeed(trendsRSS) ]);
      const items = (newsItems||[]).concat(trendsItems||[]);
      if(!items.length) { contentEl.innerHTML = '<div class="gth-error">No items found (proxies returned no data).</div>'; return; }
      items.sort((a,b)=>new Date(b.pubDate||0)-new Date(a.pubDate||0));
      // render: featured + 4 small
      const featured = items[0];
      const smalls = items.slice(1, 1+smallCount);

      // build DOM
      contentEl.innerHTML = '';
      // featured
      const fWrap = document.createElement('div'); fWrap.className='gth-featured';
      const imgWrap = document.createElement('div'); imgWrap.className='img';
      const aImg = document.createElement('a'); aImg.href = featured.link; aImg.target='_blank';
      const img = document.createElement('img'); img.src = featured.image || fallbackSvgUrl(); img.alt = featured.title || '';
      aImg.appendChild(img); imgWrap.appendChild(aImg);
      const meta = document.createElement('div'); meta.className='meta';
      const head = document.createElement('div'); head.className='headline';
      const aHead = document.createElement('a'); aHead.href = featured.link; aHead.target='_blank'; aHead.style.textDecoration='none'; aHead.style.color='inherit'; aHead.textContent = featured.title || '';
      head.appendChild(aHead);
      const syn = document.createElement('div'); syn.className='syn'; syn.textContent = catchy(featured.title||'',featured.content||'');
      const mr = document.createElement('div'); mr.className='meta-row';
      const d = document.createElement('div'); d.textContent = featured.pubDate ? new Date(featured.pubDate).toLocaleString() : '';
      const rd = document.createElement('div'); const aRead = document.createElement('a'); aRead.className='read'; aRead.href=featured.link; aRead.target='_blank'; aRead.textContent='Read full'; rd.appendChild(aRead);
      mr.appendChild(d); mr.appendChild(rd);
      meta.appendChild(head); meta.appendChild(syn); meta.appendChild(mr);

      fWrap.appendChild(imgWrap); fWrap.appendChild(meta);
      contentEl.appendChild(fWrap);

      const grid = document.createElement('div'); grid.className='gth-sm-grid';
      for(const s of smalls){
        const card = document.createElement('div'); card.className='gth-sm';
        const th = document.createElement('div'); th.className='thumb';
        const a = document.createElement('a'); a.href=s.link; a.target='_blank';
        const im = document.createElement('img'); im.src = s.image || fallbackSvgUrl(); im.alt = s.title || '';
        a.appendChild(im); th.appendChild(a);
        const info = document.createElement('div'); info.className='info';
        const h = document.createElement('div'); h.className='h';
        const ah = document.createElement('a'); ah.href=s.link; ah.target='_blank'; ah.style.textDecoration='none'; ah.style.color='inherit'; ah.textContent=s.title||'';
        h.appendChild(ah);
        const ss = document.createElement('div'); ss.className='s'; ss.textContent = shortify(s.content||'',110);
        info.appendChild(h); info.appendChild(ss);
        card.appendChild(th); card.appendChild(info);
        grid.appendChild(card);
      }
      contentEl.appendChild(grid);
      const f = document.createElement('div'); f.className='gth-footer'; f.textContent='Powered by Google News & Trends';
      contentEl.appendChild(f);

    }catch(err){
      console.error('All proxies failed:', err);
      contentEl.innerHTML = [
        '<div class="gth-error">Unable to fetch feeds from public proxies.</div>',
        '<div style="padding:10px 12px;color:#444;font-size:13px">Solutions:',
        '<ul style="margin:8px 0 0 18px"><li>Deploy a tiny serverless proxy (Netlify/Vercel) — recommended.</li>',
        '<li>Try again later (public proxies sometimes limit requests).</li></ul></div>'
      ].join('');
    }
  }

  loadAll();
})();
</script>
</body>
</html>
