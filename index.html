<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Geeta Tech Hub — News Widget</title>
  <style>
    :root{--gth-accent:#ff5b60;--gth-bg:#fff;--gth-muted:#777;--gth-radius:12px}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    .gth-wrap{max-width:980px;margin:12px auto;padding:12px}
    .gth-card{background:var(--gth-bg);border-radius:var(--gth-radius);box-shadow:0 8px 24px rgba(12,14,20,.06);overflow:hidden}
    .gth-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px}
    .gth-title{font-weight:700;font-size:18px;color:#111}
    .gth-sub{font-size:12px;color:var(--gth-muted)}
    .gth-layout{display:grid;grid-template-columns:1fr;gap:12px;padding:12px}
    .gth-featured{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;background:#fff}
    .gth-featured .img{flex:0 0 48%;max-height:260px;overflow:hidden;border-radius:10px}
    .gth-featured img{width:100%;height:100%;object-fit:cover;display:block}
    .gth-featured .meta{flex:1;display:flex;flex-direction:column;gap:8px}
    .gth-featured .headline{font-size:18px;font-weight:700;color:#111;line-height:1.15}
    .gth-featured .syn{font-size:14px;color:#222;line-height:1.4}
    .gth-featured .meta-row{display:flex;justify-content:space-between;align-items:center;color:var(--gth-muted);font-size:12px;margin-top:auto}
    .gth-featured a.read{background:transparent;border:1px solid var(--gth-accent);color:var(--gth-accent);padding:8px 10px;border-radius:8px;text-decoration:none;font-size:13px}
    .gth-sm-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .gth-sm{display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:#fff}
    .gth-sm .thumb{flex:0 0 86px;height:60px;border-radius:8px;overflow:hidden;background:#f2f2f2}
    .gth-sm img{width:100%;height:100%;object-fit:cover}
    .gth-sm .info{flex:1}
    .gth-sm .h{font-size:13px;font-weight:600;color:#111;line-height:1.2;margin-bottom:6px}
    .gth-sm .s{font-size:12px;color:var(--gth-muted);line-height:1.2}
    .gth-footer{padding:10px 14px;font-size:12px;color:var(--gth-muted);text-align:right}
    .gth-loading{padding:24px;text-align:center;color:var(--gth-muted)}
    .gth-error{padding:20px;text-align:center;color:#b00020}
    @media (max-width:720px){
      .gth-featured{flex-direction:column}
      .gth-featured .img{width:100%;height:180px}
    }
  </style>
</head>
<body>
  <div class="gth-wrap">
    <div id="gth-root" class="gth-card" role="region" aria-label="Geeta Tech Hub News Widget">
      <div class="gth-header">
        <div>
          <div class="gth-title">Geeta Tech Hub News</div>
          <div class="gth-sub">Google News + Trending searches • quick synopses</div>
        </div>
        <div class="gth-sub">Auto • Local</div>
      </div>

      <div id="gth-content" class="gth-layout">
        <div id="gth-loading" class="gth-loading">Loading headlines…</div>
      </div>
    </div>
  </div>

<script>
/*
  Improved client-side RSS fetcher using allorigins (CORS proxy) + XML parsing.
  - avoids rss2json rate issues
  - extracts images from <media:content>, <enclosure>, or first <img> in description/content
*/
(async function(){
  const country = 'IN';        // change if needed
  const smallCount = 4;
  const newsRSS = `https://news.google.com/rss?hl=en-${country}&gl=${country}&ceid=${country}:en`;
  const trendsRSS = `https://trends.google.com/trends/trendingsearches/daily/rss?geo=${country}`;
  const allOrigins = url => 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);

  const $content = document.getElementById('gth-content');
  const $loading = document.getElementById('gth-loading');

  function stripHtml(html){ if(!html) return ''; const d=document.createElement('div'); d.innerHTML = html; return d.textContent||d.innerText||''; }
  function shortify(text,lim=140){ if(!text) return ''; text = stripHtml(text).replace(/\s+/g,' ').trim(); if(text.length<=lim) return text; const s=text.slice(0,lim); const last=Math.max(s.lastIndexOf('.'),s.lastIndexOf('!'),s.lastIndexOf('?')); return (last>30? s.slice(0,last+1): s.trim()+'…'); }
  function catchy(title,desc){ const d=shortify(desc,160); const t=[`${title} — quick take: ${d}`,'Why it matters: '+d,`${title} — in brief: ${d}`,'Snapshot: '+d]; return t[Math.floor(Math.random()*t.length)]; }
  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  // parse RSS XML string -> array of items
  function parseRSS(xmlString){
    try{
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlString, "application/xml");
      const items = Array.from(doc.querySelectorAll('item')).map(it=>{
        const title = it.querySelector('title') ? it.querySelector('title').textContent : '';
        const link = it.querySelector('link') ? it.querySelector('link').textContent : (it.querySelector('guid')?it.querySelector('guid').textContent:'#');
        const description = it.querySelector('description') ? it.querySelector('description').textContent : '';
        const content = (it.querySelector('content\\:encoded') ? it.querySelector('content\\:encoded').textContent : '') || description;
        const pubDate = it.querySelector('pubDate') ? it.querySelector('pubDate').textContent : '';
        // media:content or enclosure
        let image = '';
        const m = it.querySelector('media\\:content, media\\:thumbnail');
        if(m && m.getAttribute('url')) image = m.getAttribute('url');
        if(!image){
          const encl = it.querySelector('enclosure');
          if(encl && encl.getAttribute('url')) image = encl.getAttribute('url');
        }
        // fallback: first img in content/description
        if(!image){
          const re = /<img[^>]+src=["']?([^"'>\s]+)["']?/i;
          const mm = re.exec(content || description || '');
          if(mm) image = mm[1];
        }
        return { title, link, content, description, pubDate, image };
      });
      return items;
    }catch(e){
      console.warn('XML parse error', e);
      return [];
    }
  }

  async function fetchText(url){
    try{
      const res = await fetch(allOrigins(url), {cache: 'no-cache'});
      if(!res.ok) throw new Error('Network response not ok: ' + res.status);
      const txt = await res.text();
      return txt;
    }catch(e){
      console.warn('fetchText error', e);
      throw e;
    }
  }

  // Try both feeds and merge items
  async function loadFeeds(){
    $loading.textContent = 'Loading headlines…';
    try{
      // fetch news and trends in parallel
      const [newsText, trendsText] = await Promise.all([ fetchText(newsRSS), fetchText(trendsRSS) ]);
      const newsItems = parseRSS(newsText);
      const trendsItems = parseRSS(trendsText);

      // annotate source if available (feed-level title)
      // attempt to extract feed title from news XML
      // (simple extraction)
      const feedTitleMatch = /<title>([^<]+)<\/title>/i.exec(newsText);
      const newsFeedTitle = feedTitleMatch ? feedTitleMatch[1] : 'Google News';

      const items = [];

      for(const it of newsItems){
        items.push(Object.assign({}, it, { source: newsFeedTitle }));
      }
      for(const it of trendsItems){
        items.push(Object.assign({}, it, { source: 'Google Trends' }));
      }

      if(!items.length){
        $content.innerHTML = '<div class="gth-error">No items found — try again later.</div>';
        return;
      }

      // sort by pubDate if present
      items.sort((a,b)=>{
        const ta = a.pubDate ? new Date(a.pubDate).getTime() : 0;
        const tb = b.pubDate ? new Date(b.pubDate).getTime() : 0;
        return tb - ta;
      });

      renderItems(items);
    }catch(err){
      console.error('Error loading feeds', err);
      $content.innerHTML = '<div class="gth-error">Failed to load feeds. Open browser console for details.</div>';
    }
  }

  function renderItems(items){
    const featured = items[0];
    const smalls = items.slice(1, 1 + smallCount);

    const fImg = featured.image || '';
    let html = '<div class="gth-featured">';
    if(fImg){
      html += `<div class="img"><a href="${featured.link}" target="_blank" rel="noopener noreferrer"><img alt="${escapeHtml(featured.title)}" src="${escapeHtml(fImg)}"></a></div>`;
    } else {
      html += `<div class="img"><a href="${featured.link}" target="_blank" rel="noopener noreferrer"><img alt="${escapeHtml(featured.title)}" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='800' height='480'><rect width='100%' height='100%' fill='%23f3f3f3'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%23999' font-size='20'>No image</text></svg>"></a></div>`;
    }
    html += '<div class="meta">';
    html += `<div class="headline"><a href="${featured.link}" target="_blank" rel="noopener noreferrer" style="text-decoration:none;color:inherit">${escapeHtml(featured.title)}</a></div>`;
    html += `<div class="syn">${escapeHtml(catchy(featured.title, featured.content || featured.description || ''))}</div>`;
    html += `<div class="meta-row"><div class="gth-src">${escapeHtml(featured.source||'')}</div><div><a class="read" href="${featured.link}" target="_blank" rel="noopener noreferrer">Read full</a></div></div>`;
    html += '</div></div>';

    // small grid
    html += '<div class="gth-sm-grid">';
    for(const s of smalls){
      const si = s.image || '';
      html += '<div class="gth-sm">';
      html += `<div class="thumb"><a href="${s.link}" target="_blank" rel="noopener noreferrer"><img src="${escapeHtml(si || 'data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'200\\' height=\\'120\\'><rect width=\\'100%\\' height=\\'100%\\' fill=\\'%23f2f2f2\\'/><text x=\\'50%\\' y=\\'50%\\' dominant-baseline=\\'middle\\' text-anchor=\\'middle\\' fill=\\'%23999\\' font-size=\\'12\\'>No image</text></svg>')}\" alt=""></a></div>`;
      html += '<div class="info">';
      html += `<div class="h"><a href="${s.link}" target="_blank" rel="noopener noreferrer" style="text-decoration:none;color:inherit">${escapeHtml(s.title)}</a></div>`;
      html += `<div class="s">${escapeHtml(shortify(s.content||s.description||'',110))}</div>`;
      html += '</div></div>';
    }
    html += '</div>';
    html += '<div class="gth-footer">Powered by Google News & Trends</div>';

    $content.innerHTML = html;
  }

  // start
  loadFeeds();

})();
</script>
</body>
</html>
